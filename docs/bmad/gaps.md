# 不足点・未決定事項（BMAD Methodの観点）

このリストは「仕様として決める必要があること」を集約します。決まったものは `docs/bmad/spec-current.md` に反映してここはクローズします。

## 最優先（混在/事故につながる）
- [ ] **ユーザー識別/マルチユーザー方針**: 現状は `LINE_USER_ID` にPushする運用前提だが、webhookの `source.userId` とどう紐付けるか（複数ユーザー対応する/しない、いつする）
- [ ] **ジョブ/管理APIの認証方針**:
  - 現状: `/api/line/push` は `INTERNAL_API_KEY` で保護されているが、`/api/jobs/*` は Vercel Cron 都合で未保護
  - 決める: cronを壊さずに保護する方法（IP allowlist / Vercel側の保護 / 外部ジョブ実行基盤への移管 など）

## 仕様の穴（状態/遷移/整合性）
- [ ] **Goalのstatus遷移定義**: `pending/approved/archived` をいつ/誰が/どう更新するか（現状は追加のみ）
- [ ] **Taskのstatus語彙の固定**: `todo/done/miss` 以外を許すか、missの再スケジュール概念を持つか
- [ ] **重複生成の扱い**: `#タスク整理` を同じログに対して複数回実行したい/したくない（現状はanalysis済みだと拒否）
- [ ] **セッション残留（開始した覚えがない / 終了が効かない）時の復旧**:
  - 現状は `sessions` に end が無いセッションが残ると「別モードが動いている」でブロックされる
  - 決める: 自動失効（TTL）/ 強制終了コマンド / 管理者リセット / キーワード不一致時のガイド など

## UX/会話仕様
- [x] **パターンマッチコマンドの優先順位**: 他のモード（ステータス、日報、思考ログ）中でも以下のコマンドを常に優先して実行する（2024-12-31 修正済み）
  - 対象コマンド: `#設定`, `status <taskId>`, `split <taskId>`, `retry <taskId>`, `#ゴール一覧`, `#ゴール進捗`, `#ゴール完了`
  - 実装内容: リセットコマンドと同様に「常に優先」リストに移動
  - 修正前: ステータスモード中にこれらのコマンドを送ると「1〜8の番号、または 0（終了）を送ってください。」というエラーが出ていた
  - 修正後: どのモード中でもこれらのコマンドが正しく実行される
  - 処理順序: ヘルプ → リセット → パターンマッチコマンド → ステータスモード判定 → キーワードコマンド → 日報/思考ログモード判定
- [ ] **日報での入力例/エラーメッセージ整備**: taskIdの提示/コピペしやすさ、失敗時の再試行導線
- [ ] **日報の「対象」状態の明示**: `list` / `対象 1,3` の返信に「現在の対象: 全件 / N件」を必ず含める（解除導線も併記）
- [ ] **postbackの仕様範囲**: `approve_goal:` 以外（延期/完了ボタンなど）を追加するか

## 非機能（運用/信頼性/コスト）
- [x] **タスク更新失敗の検知と通知**: done/miss コマンド実行時に更新成否を検証し、失敗時はユーザーに明確なエラーメッセージと再試行方法を提示する（2024-12-30 修正済み）
  - 実装内容: updateStatus の戻り値確認、try-catch による Sheets API エラー捕捉、更新後の状態検証、詳細なエラーメッセージとログ
  - 新機能: `status <taskId>` コマンドでタスクの現在の状態を確認可能
- [x] **パーソナライズ設定保存失敗の検知と通知**: #設定 コマンド実行時に保存成否を検証し、失敗時はユーザーに明確なエラーメッセージを提示する（2024-12-31 修正済み）
  - 実装内容: upsert の try-catch によるエラー捕捉、保存後の検証機能（verifyUpdate）、詳細なエラーメッセージとログ
  - 修正箇所: `lib/storage/sheets-repository.ts` の `SheetsUserSettingsRepository.upsert` と `app/api/line/webhook/route.ts` の `handleSettingsCommand`
  - 検証方法: 保存後500ms待機してキャッシュ無効化し、再取得して期待値と比較
- [ ] **DeepSeek失敗時の期待動作**: リトライ方針、ユーザーへのメッセージ、部分成功（ログ保存だけする等）
- [ ] **Google Sheetsの上限/運用**: 行数増加時のパフォーマンス、バックアップ、スキーマ変更手順
- [ ] **PII/ログ方針**: DeepSeek HTTPログを有効化した際に何を残すか、マスキングの要否
- [ ] **時刻/タイムゾーン**: CronのUTC/JST、logsのtimestampの扱い

## テスト/品質ゲート
- [ ] **受入条件（Given/When/Then）**: 最低限の主要フロー（思考ログ→タスク化→日報→週次）
- [ ] **モック戦略**: LINE/DeepSeek/Sheets の契約テスト or 疑似実装
- [ ] **回帰観点**: キーワード変更やプロンプト変更で壊れやすい箇所の固定（ゴールデンテキスト等）

---

## 受入条件テンプレ（埋めていく）
### 思考ログ（開始→会話→終了）
- Given: ユーザーがLINEでボットに話しかける
- When: `#整理開始`（または `#ログ開始`）を送る
- Then: 「思考ログモード開始」メッセージと終了方法（`#整理終了`）が返る

- Given: 思考ログモード中
- When: 任意の文章を送る
- Then: DeepSeek分析結果が返り、sessionsに user/assistant イベントが追記される

- Given: 思考ログモード中で、ユーザー発話が1件以上ある
- When: `#整理終了`（または `#ログ終了`）を送る
- Then: セッションが終了し、次に `#タスク整理` でタスク化できる案内が返る

### タスク整理（#タスク整理）
- Given: 直近に終了済みの思考ログセッションがある
- When: `#タスク整理` を送る
- Then: logsに1件、tasksに1件以上のtodoが追加され、返信に「このログID」が含まれる

- Given: すでにタスク化済みの思考ログセッションがある
- When: 同じ対象に対して `#タスク整理` を送る
- Then: 仕様で定めたとおり（現状は拒否）に案内される

### 日報（開始→更新→終了）
- Given: 日報モードではない
- When: `#日報開始` を送る
- Then: todo一覧（ID付き）と入力例（done/miss/note/list）が返る

- Given: ユーザーは「日報を開始した覚えがない」または「#日報終了を送っても解除されない」と感じている
- And: `sessions` に end無しセッションが存在する（= アクティブセッション扱いでブロックされる）
- When: ユーザーが `#日報開始` を送る
- Then: 何のモードが残っているか（daily/log）と、終了すべきコマンド（`#日報終了` / `#整理終了`）を明示して返す
- And: 復旧導線（例: 強制終了/失効/管理者リセット）を案内する（仕様で定める）

- Given: 日報モード中で todo がある
- When: `done <taskId>` を送る
- Then: tasksのstatusがdoneになり、日報サマリーに✅完了として記録される
- And: 更新が成功した場合「✅完了登録: {説明}」が返る
- And: 更新が失敗した場合、エラー詳細と再試行方法が返る

- Given: 日報モード中で todo がある
- When: `miss <taskId> <理由?>` を送る
- Then: tasksのstatusがmissになり、日報サマリーに❌未達として記録される
- And: 更新が成功した場合「❌未達登録: {説明} | 理由: {理由}」が返る
- And: 更新が失敗した場合、エラー詳細と再試行方法が返る

- Given: ユーザーがタスクの状態を確認したい
- When: `status <taskId>`（または `ステータス <taskId>` / `確認 <taskId>`）を送る
- Then: タスクのID、ステータス、説明、優先度、期限、割当日時、ソースログIDが返る

- Given: 日報モード中
- When: `list`（または `一覧`）を送る
- Then: todo一覧（ID付き）が再表示される

- Given: 日報モード中
- When: `#日報終了` を送る
- Then: 日報サマリーが返り、logsにサマリーが追記される（更新があった場合）
- And: 評価/明日の焦点/タスク見直し案/後続タスク提案が返る（DeepSeek失敗時はサマリーのみでもよい）
- And: 後続タスクが提案された場合、tasksにtodoとして追加される
- And: task_review（再スケジュール案）が sessions に保存される

- Given: 日報提案が sessions に保存されている
- When: `#再スケジュール作成`（または `#再スケジュール作成 <dailyLogId>`）を送る
- Then: 提案に含まれる reschedule 対象から、再スケジュール用タスク（todo）が tasks に追加される
- And: 二重作成は防止される（同じ日報に対する複数回適用は拒否される）

### ジョブ（morning/weekly）
- Given: `INTERNAL_API_KEY` が設定されている
- When: `/api/jobs/morning` をキー付きで叩く
- Then: LINEに朝メッセージがpushされる
