# 現行仕様（BMAD Method: B/M/A/D）

このドキュメントは **現状のコード/設定から確定できる“事実ベース”の仕様**です（理想案・将来案は含めない）。

## B (Business / Background)
- **体験ゴール**: LINE上で「思考ログ→整理（AI）→タスク化→日報→週次レビュー」まで完結させる。
- **主な価値**: アプリを開かずに通知/チャットのみで行動を前に進める。

## M (Market / Modeling)
### 想定ユーザー
- LINEで日々の状況/感情/進捗を送る個人ユーザー（現状は `LINE_USER_ID` を単一ユーザーとして扱う運用が前提）。

### ドメイン（データモデル）
- **Goal**: `id,title,confidence,status,createdAt,updatedAt`
  - status: `pending | approved | archived`（ただし現行API/実装では主に `pending` を作る）
  - **ゴールとタスクの連携**: タスクの `goalId` でゴールと紐付く
  - **進捗計算**: ゴールに紐づくタスクの完了数/総数で進捗率を計算
- **Task**: `id,goalId,description,status,dueDate,priority,assignedAt,sourceLogId`
  - status: `todo/done/miss` を主に使用（文字列で自由だが日報処理がこれを前提）
  - priority: `A/B/C` を想定
  - **goalId**: どのゴールに貢献するタスクかを示す
- **Log**: `id,timestamp,userId,rawText,emotion,coreIssue,currentGoal,todayTask,warning`
- **SessionEvent (sessionsシート)**: `sessionId,userId,type,content,timestamp,meta`
  - mode: `log | daily`（startイベントのmetaで保持）

### 永続化（Google Sheets スキーマ）
- **goals**: `id,title,confidence,status,createdAt,updatedAt`
- **tasks**: `id,goalId,description,status,dueDate,priority,assignedAt,sourceLogId`
- **logs**: `id,timestamp,userId,rawText,emotion,coreIssue,currentGoal,todayTask,warning`
- **sessions**: `sessionId,userId,type,content,timestamp,meta`
- **user_settings**: `userId,characterRole,messageTone,displayName,createdAt,updatedAt`

### 主要フロー（LINE）
#### 1) 思考ログ（logモード）- **対話的な深層心理探求**
- 開始: `SESSION_START_KEYWORD`（デフォルト `#整理開始`）
  - 互換コマンド: `#ログ開始` でも開始できる（レガシーalias）
  - メッセージ: 「今、何が気になってる？ふわっとした気持ちでいい。そのまま送って。」
- **対話の特徴**:
  - ユーザーの言葉の奥にある深層心理を探る質問を返す
  - 表面的な言葉ではなく、「なぜ？」「本当は？」と問いかける
  - 思考の矛盾や前提を優しく指摘し、ユーザー自身が気づくように導く
- **メッセージ分割**:
  - やり取りが増えても読みやすいよう、AIの返信は3つに分割
  - 1つ目: 感情の共感
  - 2つ目: 現状の整理と気づきの提案
  - 3つ目: 核心を突く質問
- 会話: ユーザーが送るたびに DeepSeek で深層心理分析（JSON抽出）し、対話的に返信
- 終了: `SESSION_END_KEYWORD`（デフォルト `#整理終了`）
  - 互換コマンド: `#ログ終了` でも終了できる（レガシーalias）
  - メッセージ: 「思考の整理、お疲れ様。今の気持ちを言語化できたね。」
- その後: `TASK_SUMMARY_COMMAND`（デフォルト `#タスク整理`）で、終了済みログを基にタスク生成

#### 2) タスク整理（ログ→タスク生成）
- 入力: セッションのユーザー発話ログ（複数行の transcript）
- 出力: logs に1件追加 + tasks に複数件追加（AI JSONの `tasks` を採用）
- **ゴール自動作成**: AIが抽出した `currentGoal` を自動的にgoalsシートに追加（重複チェック付き）
  - 同じタイトルのゴールが既に存在する場合は既存のIDを使用
  - 新規の場合は `g_` prefixのIDを生成してgoalsシートに追加
  - タスクの `goalId` にはgoalsシートの実際のIDを保存

#### 3) 日報（dailyモード）
- 開始: `DAILY_START_KEYWORD`（デフォルト `#日報開始`）
  - todoタスクを優先度順に **2-3件** 表示（見やすさ重視）
  - **各タスクにゴール情報を表示**（どのゴールに貢献しているか）
  - 全件表示は `list` コマンドで確認可能
  - `#日報開始 1,3` のように後ろに番号/IDを並べると、日報対象タスクを絞り込んで開始できる
- 更新（同モード中のメッセージ）:
  - **推奨入力形式**（動詞が先）:
    - 完了: `done 1` / `完了 1`
      - **done時の次タスク案内**: 残りtodoがある場合、次のタスクを自動で提示（「もう1件いける？」）
      - モチベーション向上: 日中に完了した場合もう一つタスクをこなせるよう案内
    - 未達: `miss 2 理由` / `未達 2 理由`
      - **miss時は次のアクション提案**（再挑戦/分割/延期の選択肢）
    - メモ: 上記以外は全てメモとして記録
  - **間違った形式の検知**:
    - 逆順（`1 done` / `2 miss 理由`）を送ると、正しい形式を提示してエラーを返す
    - 理由: タスクIDは `t_` から始まるため、番号とIDの混同を避けるため動詞を先に書く
  - task status 更新（done/miss）
    - **更新成否を検証し、失敗時は詳細なエラーメッセージを返す**
    - 更新後の状態を確認して整合性を保証
  - sessions に daily_update を記録
  - `list` / `一覧` で todo 一覧を再表示できる
  - `対象 1,3`（または `report 1,3`）で「日報対象タスク」をメッセージ指定できる（解除は `対象 全部`）
  - **番号**は todo全件リスト基準（対象で絞っても番号は変わらない）
  - `status <taskId>`（または `ステータス <taskId>` / `確認 <taskId>`）でタスクの現在の状態を確認できる
  - **メッセージは分割表示**で読みやすく（LINEのreplyMessages機能を使用）
- 終了: `DAILY_END_KEYWORD`（デフォルト `#日報終了`）
  - daily_update を集計してサマリー化
  - **モチベーション向上機能**:
    - 進捗サマリー表示（「今日は2件完了！達成率67%」）
    - ストリーク表示（「🔥 連続5日！」）- 日報を連続で記録した日数
    - **ゴール進捗表示**（「キャリアアップ: ████░░░░░░ 40%」）- 最大3件
  - サマリーを logs に追記（rawTextにサマリー文字列）
  - サマリーと未着手todo一覧を元に DeepSeek で「評価/明日の焦点/タスク見直し案/後続タスク」を生成し返信
  - 後続タスク（0〜5件）が提案された場合は tasks に todo として追加する（sourceLogId は日報logId）
  - タスク見直し案（再スケジュール案）を sessions に保存する
  - 再スケジュール案はこの時点では適用しない（提案表示のみ）
  - ユーザーが `DAILY_RESCHEDULE_COMMAND`（デフォルト `#再スケジュール作成`）を送ると、直近の日報提案から **再スケジュール用の新規タスク（todo）** を作成する
    - `#再スケジュール作成 <dailyLogId>` で対象日報を指定できる

### Cron/ジョブ
- `/api/jobs/morning` (GET/POST): 次の todo 1件を「今日の焦点」としてPush
  - **AIによるスマートタスク選定**: 期限、優先度、ゴールバランス、最近の進捗を考慮
  - 次のtodoの並び順（AI失敗時）: priority（A→B→C→不明）→ dueDate（早い順/空は後ろ）→ assignedAt（早い順/空は後ろ）→ シート行順
  - **モチベーション向上**: 日替わりの励ましメッセージ（「おはよう。今日もやっていこう。」など）
  - **パーソナライズ**: ユーザー設定に応じてキャラクターロール・トーンを適用
  - **対話機能**: 「このタスクでOK？変更希望なら『変更』と送って」を追加
  - Push本文は「今日の焦点 / 選定理由（AI） / 報告方法 / ポイント」を含む
  - 当日の命令タスクIDを `sessions` に `morning_order` として記録する（todoが無い場合は空で記録し、前日の命令が誤って参照されないようにする）
- `/api/jobs/night` (GET/POST): 夜の確認メッセージをPush
  - 返信は `完了` または `未達 <理由1行>` のみを要求する
  - 返信が日報/思考ログのどのモードでもない場合でも、`完了/未達` を受理し、直近の `morning_order` に紐づくタスクを done/miss 更新（IDが取れない場合は記録のみ）
  - **更新成否を検証し、失敗時はユーザーに警告と再試行方法を提示する**
- `/api/jobs/weekly` (GET/POST): 直近7日ログから週次レビュー（DeepSeek JSON）を生成してPush
  - **モチベーション向上**: ポジティブなフィードバック（「今週の成果」「次の目標」「来週の焦点」）
- Vercel Cron: `vercel.json` で morning/weekly が定期実行（nightは現状スケジュール外）

## A (Architecture / Assemble)
### 実行基盤
- Next.js App Router（`app/api/**/route.ts`）が実運用の中心。
- Python側（`apps/api`, `apps/orchestrator`）は同居しているが、現行のLINE/タスク/ログの主フローはNext.js側。

### 外部連携
- **LINE Messaging API**: `replyMessage` / `pushMessage`
- **DeepSeek**: `https://api.deepseek.com/v1/chat/completions`（modelは `DEEPSEEK_MODEL` or `deepseek-chat`）
- **Google Sheets**: 永続化（goals/tasks/logs/sessions シート）

### API（Next.js）
- `POST /api/line/webhook`: LINE受信（text messageのみ）→ セッション制御/DeepSeek応答/タスク生成/日報更新
  - `x-line-signature` を検証し、不正な場合は 401 を返す
- `POST /api/line/postback`: postback受信（`approve_goal:<内容>` のみ対応）→ goalsに追加
  - `x-line-signature` を検証し、不正な場合は 401 を返す
- `POST /api/line/push`: 管理用 push（userId省略時は `LINE_USER_ID`）
  - `INTERNAL_API_KEY` による内部認証が必要（Authorization Bearer / `x-internal-api-key` / `?key=`）
- `GET /api/test-deepseek`: DeepSeek疎通確認用（デバッグ用途）
- `GET|POST /api/jobs/morning`: 朝の命令Push
- `GET|POST /api/jobs/night`: 夜の確認Push
- `GET|POST /api/jobs/weekly`: 週次レビューPush
- `GET|POST /api/goals`: goals一覧 / 追加
- `GET|POST /api/tasks`: todo一覧 / 追加
- `GET /api/progress`: 直近ログの取得（3日/最大20行）

## D (Delivery / Deploy)
- **必須環境変数（現行運用に必要）**
  - DeepSeek: `DEEPSEEK_API_KEY`（任意: `DEEPSEEK_MODEL`, `DEEPSEEK_MAX_TOKENS`, `DEEPSEEK_HTTP_LOG*`）
  - LINE: `LINE_CHANNEL_ACCESS_TOKEN`, `LINE_CHANNEL_SECRET`, `LINE_USER_ID`
  - Sheets: `GOOGLE_CLIENT_EMAIL`, `GOOGLE_PRIVATE_KEY`, `SHEETS_SPREADSHEET_ID`
  - Internal Auth: `INTERNAL_API_KEY`（/api/line/push の実行に必要）
  - Sessionコマンド: `SESSION_START_KEYWORD`, `SESSION_END_KEYWORD`, `TASK_SUMMARY_COMMAND`, `DAILY_START_KEYWORD`, `DAILY_END_KEYWORD`（任意）
- **Vercel Cron**: `vercel.json` で morning/weekly を定期実行

---

## 新機能（2024-12-30 追加）

### 0. パーソナライズとタスク選定の対話化（フェーズ1完了）
**概要**: ユーザーの責任感を高め、状況に応じた柔軟なタスク選定を可能にする。

#### パーソナライズ機能
**実装内容:**
- **キャラクターロール**: ユーザーが社長・御曹司・アスリート・研究者などのロールを選択可能
  - `default`: デフォルト（鬼コーチ）
  - `ceo`: 社長（「社長、今日の経営課題は...」）
  - `heir`: 御曹司（「若様、今日の修行は...」）
  - `athlete`: アスリート（「選手、今日のトレーニングは...」）
  - `scholar`: 研究者（「博士、今日の研究テーマは...」）
- **メッセージトーン**: メッセージの口調を選択可能
  - `strict`: 厳格（「〜しろ」「〜だ」）- デフォルト
  - `formal`: 敬語（「〜してください」「〜です」）
  - `friendly`: フレンドリー（「〜しよう」「〜だね」）
- **設定コマンド**: `#設定 キャラクター 社長`, `#設定 トーン 敬語`, `#設定 名前 田中`

**データモデル:**
- 新シート `user_settings`: `userId, characterRole, messageTone, displayName, createdAt, updatedAt`

#### 朝の命令の対話化
**実装内容:**
- **タスク変更機能**: 朝のタスク提示に対して、ユーザーが「変更」と送ることで候補タスクを確認・選択できる
- **条件指定**: 「スマホのみ」「軽いタスク」「今日は休む」などの条件を指定可能
- **候補タスク提示**: 最大3件の候補を番号付きで表示

**フロー:**
```
1. 朝のタスク自動Push（AIが最適なタスクを選定）
2. 「このタスクでOK？変更希望なら『変更』と送って」
3. ユーザーが「変更」と返信
4. 候補タスク3件を提示（または条件指定）
5. ユーザーが番号で選択 or 「今日は休む」
6. 選択されたタスクを morning_order に記録
```

#### AIによるスマートタスク選定
**実装内容:**
- **考慮要素**:
  1. 期限が近いタスク（3日以内）は優先
  2. 優先度Aは重視するが、Aばかりに偏らないようバランスを取る
  3. ゴールの進捗が遅れているゴールのタスクを優先
  4. 最近の傾向（missが続いている場合は軽めのタスクを）
- **選定理由の表示**: AIが選んだ理由を朝のメッセージに追加表示
- **フォールバック**: AIが失敗した場合は従来通り優先度順で先頭を選択

---

### フェーズ2: UI統合（2024-12-30完了）

#### 1. フィードバック機能のUI統合
**概要**: タスク完了時にAI選定の満足度をユーザーから収集し、学習に活用する。

**実装内容:**
- **朝のタスク完了時**: `done` コマンドで朝のタスクを完了すると、満足度を聞く
  - 「👍 よかった」
  - 「👎 別のがよかった」
  - 「⏭️ スキップ（後で答える）」
- **フィードバック記録**: `sessions` シートに `task_feedback` として記録
- **次回の選定に反映**: 今後のAI選定精度向上に活用（フェーズ4で実装予定）

**フロー:**
```
done 1 を送信
↓
✅ よくやった！
プレゼン資料を作成する

💭 このタスクは適切でしたか？
👍 よかった
👎 別のがよかった
⏭️ スキップ（後で答える）
↓
ユーザーが 👍 を送信
↓
👍 ありがとう。
AIのタスク選定に反映する。

続けて報告するか、今日はここまでにするか選んで。
```

#### 2. 自動優先度調整のcron統合
**概要**: 毎朝のタスク選定前に、期限が近いタスクの優先度を自動調整する。

**実装内容:**
- **調整ロジック**: 期限が3日以内のタスクを優先度Aに自動引き上げ
- **実行タイミング**: 朝のcronジョブ（`/api/jobs/morning`）実行時
- **ログ記録**: 調整されたタスクをコンソールログに記録

**フロー:**
```
朝のcronジョブ実行
↓
priorityService.adjustPriorities()
  → 期限が近いタスクをチェック
  → 優先度をAに引き上げ
↓
AIタスク選定
  → 調整後の優先度で選定
↓
ユーザーにPush
```

---

### フェーズ3: 高度な学習（2024-12-30完了）

#### 3. ユーザー行動パターン学習
**概要**: ユーザーの過去のタスク完了/未達データから行動パターンを分析し、最適なタスク提案に活用する。

**分析データ:**
- **曜日別完了率**: 月曜は完了率高い、金曜は低い、など
- **タスクタイプ別完了率**: 読む系は得意、書く系は苦手、など
- **時間帯別傾向**: 朝は集中力高い、夜は低い、など

**データ構造:**
```typescript
{
  weekdayPerformance: {
    0: { done: 5, miss: 2, total: 7, rate: 0.71 },  // 日曜
    1: { done: 10, miss: 3, total: 13, rate: 0.77 }, // 月曜
    // ...
  },
  taskTypePreference: {
    reading: 0.85,    // 読む系は得意
    writing: 0.60,    // 書く系は普通
    meeting: 0.45,    // 会議系は苦手
    research: 0.75,   // 調べる系は得意
    creative: 0.55    // 作る系は普通
  }
}
```

**実装:**
- `lib/core/behavior-learning-service.ts`: `BehaviorLearningService`

#### 4. 曜日・時刻別のタスク提案
**概要**: 朝のタスク選定時に、曜日と時刻に基づいた提案メッセージを表示する。

**提案例:**
- 月曜・朝: 「月曜は完了率が高い！チャレンジングなタスクもいけそうです。朝は集中力が高い時間帯。重要なタスクに取り組みましょう。」
- 金曜・夜: 「この曜日は完了率が低い傾向があります。軽めのタスクを選びましょう。夜は軽めのタスクがおすすめ。読む・調べる系がいいでしょう。」

**統合フロー:**
```
朝のcronジョブ実行
↓
自動優先度調整（期限が近いタスク → A）
↓
行動パターン分析（曜日・時刻・タイプ別）
↓
AIスマートタスク選定（期限・ゴールバランス・行動パターンを考慮）
↓
パーソナライズ（キャラクター・トーン適用）
↓
ユーザーにPush
  - 今日の焦点
  - AI選定理由
  - 今日の傾向（曜日・時刻別提案）
  - 対話機能（変更可能）
↓
ユーザーが完了報告
↓
フィードバック要求（満足度）
↓
次タスク案内 or 全タスク完了
```

**表示例:**
```
🎯 社長、今日の経営課題
プレゼン資料を作成する

💡 AI選定理由:
優先度Aで期限が明日。ゴール進捗が40%と遅れているため。

📊 今日の傾向:
月曜は完了率が高い！チャレンジングなタスクもいけそうです。
朝は集中力が高い時間帯。重要なタスクに取り組みましょう。

🔄 このタスクでOK？
・変更希望なら「変更」と送って
・条件指定なら「スマホのみ」「軽いタスク」など
```

---

### 1. キーワードレス化
**概要**: ユーザーが `#整理開始` などのキーワードを覚えなくても、番号やAIの自動判断でモードを開始できる。

**実装内容:**
- **番号でモード選択**: `1` = 思考ログ、`2` = 日報、`3` = タスク整理
- **AI自動判断**: ユーザーが「モヤモヤ」「悩み」などのキーワードを含むメッセージを送ると、自動で思考ログモードを開始
- **「終了」で終了**: `#整理終了` の代わりに「終了」でも終了できる
- **LINEクイックリプライボタン**: タップで選択できる

**判断キーワード:**
- 思考ログ: モヤモヤ、悩み、考え、迷、不安、困、どうしよう、わからない
- 日報: 報告、完了、未達、done、miss、やった、できた、できなかった

### 7. ステータス確認（#ステータス）
**概要**: 現在の設定、タスク、ゴール進捗、統計情報を一度に確認できる。

**コマンド:** `#ステータス` または `#状態` または `#status` または `ステータス`

**表示形式:**
- **LINE**: 4つのメッセージに分割して送信（読みやすさ向上、5000文字制限対応）
  1. パーソナライズ設定 + 今日のタスク
  2. ゴール進捗
  3. タスクサマリー + 最近の活動
  4. 統計情報 + 推奨アクション + コマンド一覧

**表示内容:**
1. **パーソナライズ設定**
   - キャラクターロール（社長/御曹司/アスリート/研究者/デフォルト）
   - メッセージトーン（厳格/敬語/フレンドリー）
   - 表示名（カスタム設定）
   - 変更方法の案内

2. **今日のタスク**
   - 朝の命令タスク（今日の焦点）
   - 重要なタスク（優先度A、期限が近いもの最大3件）

3. **ゴールと進捗**
   - アクティブなゴール（最大5件）
   - 進捗バー（視覚的表示: █████░░░░░ 50%）
   - 完了件数/総件数

4. **タスクサマリー**
   - 残りタスク総数
   - 優先度別タスク数（A/B/C）
   - 期限切れタスク数

5. **最近の活動**
   - 連続記録日数（ストリーク）🔥
   - 直近3日の記録件数
   - 最近完了したタスク（最大3件）

6. **統計情報**
   - 今週の完了件数
   - 今月の完了件数
   - 全体の完了率

7. **推奨アクション**
   - 状況に応じた次のアクション提案（最大3件）
   - 期限切れタスクの警告
   - ストリーク継続の励まし
   - タスク分割の提案など

**API:**
- `GET /api/status?userId=<userId>&format=<text|json>`: ステータス情報を取得
  - `format=text`: テキスト形式（デフォルト）
  - `format=json`: JSON形式

**実装:**
- `lib/core/status-service.ts`: `getUserStatus()`, `formatStatusInfo()`, `formatStatusInfoForLine()`
- `app/api/line/webhook/route.ts`: `handleStatusCommand()` - 複数メッセージ送信対応

### 2. タスク分割
**概要**: 大きなタスクをAIが細かいサブタスクに分割する。

**コマンド:** `split 1` または `split t_123`

**フロー:**
1. ユーザーが `split` コマンドを送信
2. AIがタスクを分析し、3〜5個のサブタスクを提案（30分〜1時間で完了できる粒度）
3. ユーザーが「承認」と送信
4. 元タスクを `done` にし、サブタスクを `todo` として追加

**出力形式:**
- 各サブタスクに `description`, `priority`, `reason`（なぜこのサブタスクが必要か）を付与

### 3. タスク再挑戦
**概要**: `miss` タスクを `todo` に戻す。

**コマンド:** `retry 1` または `retry t_123`

**フロー:**
1. ユーザーが `retry` コマンドを送信
2. `miss` タスクを探す
3. ステータスを `miss` → `todo` に更新
4. 「もう一度やってみよう。今度はできる。」と励ます

### 4. タスク生成時の理由説明
**概要**: タスクが生成されるとき、「なぜこのタスクが必要か」を説明する。

**実装:**
- AI（DeepSeek）のプロンプトに `reason` フィールドを追加
- タスク一覧表示時に理由も表示

**データモデル:**
- `Task` に `reason?: string` を追加

### 5. 週次進捗の比較（先週比）
**概要**: 週次レビュー時に、今週と先週の記録件数を比較し、増減を表示する。

**実装:**
- 先週の同期間のログを取得し、件数を比較
- 増減率を計算し、📈（増加）📉（減少）📊（同じ）で表示

**例:**
```
今週の記録: 15件
📈 先週より3件多い（+25%）
```

### 6. マイルストーン・バッジ
**概要**: ストリーク（連続日数）と完了件数に応じて、達成バッジを表示する。

**バッジ一覧:**
- **ストリーク:**
  - 🔥 3日連続
  - 🥉 7日連続（ブロンズ）
  - 🥈 14日連続（シルバー）
  - 🥇 30日連続（ゴールド）
  - 💎 50日連続（ダイヤモンド）
  - 🏆 100日連続（レジェンド）
- **完了件数:**
  - 🌱 10件完了（初心者卒業）
  - 🎯 50件完了（ハンター）
  - 💪 100件完了（百人力）
  - ✨ 300件完了（プロ）
  - ⭐ 500件完了（エキスパート）
  - 🌟 1000件完了（マスター）

**表示タイミング:**
- 日報終了時に、現在のバッジを表示

---

### 7. 月次・四半期レビュー（週次cronで自動判定）
**概要**: 週次cronの実行時に、月末・四半期末を判定して追加でレビューを実行する。

**実装:**
- `isEndOfMonth()`: 翌日が別の月かを判定
- `isEndOfQuarter()`: 翌日が別の四半期かを判定（3月末、6月末、9月末、12月末）
- 月末の場合: 30日分のログとタスク実績を集計し、月次レビューを送信
- 四半期末の場合: 90日分のログとタスク実績を集計し、四半期レビューを送信

**月次レビューの内容:**
- 今月の記録件数
- 今月のタスク実績（完了件数、達成率）
- 総評（3〜5行、成長の視点）
- 今月の主な成果（3つ）
- 来月の目標
- 来月の最初の焦点タスク

**四半期レビューの内容:**
- 今四半期の記録件数
- 今四半期のタスク実績（完了件数、達成率）
- 総評（5〜7行、長期的な視点）
- 今四半期の主な成果（インパクトの大きいもの3つ）
- 来四半期の戦略的目標
- 来四半期の最初の焦点

**cronの制約:**
- Vercelのcronは2つまで（morning, weekly）
- 月次・四半期は週次cronに統合して実行

### 8. 学習とパーソナライズ
**概要**: ユーザーの行動パターンを分析し、AIが自動で提案を生成する。

**分析内容:**
- **優先度別の傾向**: A/B/Cごとの完了率
- **曜日別の傾向**: 0=日曜〜6=土曜ごとの完了率
- **missタスクのパターン**: よくmissするキーワード、平均文字数
- **doneタスクのパターン**: よく完了するキーワード、平均文字数
- **全体の傾向**: 総タスク数、完了数、未達数、達成率

**提案の種類:**
1. **優先度調整**: 優先度Aの達成率が50%未満 → 「Aタスクを減らすか、優先度を見直しましょう」
2. **タスク簡略化**: missタスクの平均文字数がdoneタスクの1.5倍以上 → 「タスクを細かく分割してみましょう」
3. **時間調整**: 特定の曜日の達成率が30%未満 → 「この曜日は負担の少ないタスクを割り当てましょう」
4. **励まし**: 全体の達成率が70%以上 → 「この調子でいきましょう」

**表示タイミング:**
- 日報終了時に最大2件の提案を表示

---

### フェーズ4: 予測と最適化（2024-12-30完了）

#### ゴール達成予測
**概要**: 過去4週間のタスク完了ペースから、ゴールの達成予定日を予測します。

**予測内容**:
- 完了予定日・週あたりペース・信頼度（高/中/低）・推奨アクション

**表示場所**:
- `#ゴール進捗 <ゴール名>` コマンド
- 週次レビュー

#### タスク配分最適化
**概要**: 全ゴールを分析し、優先順位付けします。

**優先度**:
- 🚨 urgent: 完全に停滞（2週間以上進捗なし）
- ⚡ high: 進捗が遅い、またはもうすぐ完了
- 📌 normal: 順調

#### リスク検知
**概要**: ゴールの状態を監視し、4種類のリスクを自動検知します。

**リスク**:
1. 停滞（2週間以上進捗なし）
2. 期限リスク（完了まで半年以上）
3. タスク過多（未完了20個以上）
4. ゴール間不均衡（進捗のバラツキ）

**実装**: `lib/core/goal-prediction-service.ts`

---

## 今後の改善（未実装）
- [ ] より高度な学習とパーソナライズ（時系列分析、予測）
- [x] AIによる自動優先度調整（フェーズ2で実装済み）
- [x] ゴールの自動分解と進捗予測（フェーズ4で実装済み）
