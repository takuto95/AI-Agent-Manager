# 日報UX改善（2024-12-30）

## 問題の概要

ユーザーから以下のフィードバックを受けた：
1. **入力形式が分かりにくい**: `1 done` と入力したが認識されなかった（`done 1` のみ対応）
2. **メッセージが長い**: 日報開始時のメッセージが長く、使い方が分かりにくい

## 実装した改善

### 1. 明確な入力形式の推奨とエラー検知

#### ユーザーからのフィードバック

最初は `1 done` / `done 1` 両方を受け入れる実装をしましたが、ユーザーから以下の指摘を受けました：

> タスクIDが `t_` から始まる採番なのに、`1 done` の形式って分かりづらくありませんか？

**確かに混乱を招く:**
- タスクIDは `t_1766122744120_1` のように `t_` から始まる
- 番号は `1, 2, 3...`
- `1 done` は「番号1？タスクID `1`？」と曖昧

#### 推奨形式（修正後）

**`done 1`（動詞が先）のみを推奨:**
- `done 1` / `完了 1`
- `miss 2 理由` / `未達 2 理由`

**理由:**
- 動詞が先の方が明確（「何をする」が先）
- タスクIDと番号の混同を避ける

#### 間違った形式の検知

逆順（`1 done` / `2 miss 理由`）を送ると、具体的なエラーメッセージを返す：

**ユーザー入力:**
```
1 done
```

**システム応答:**
```
⚠️形式が間違っている: 1 done

正しい形式:
done 1

理由: タスクIDは t_ から始まるので、
番号とIDを混同しないよう、動詞を先に書く。
```

#### 実装詳細

```typescript
// 正しい形式のみマッチ
const doneMatch = userText.match(/^(done|完了)\s+(\S+)$/i);
const missMatch = userText.match(/^(miss|未達)\s+(\S+)(?:\s+(.+))?$/i);

// 間違った形式（逆順）の検知
const reverseDoneMatch = userText.match(/^(\S+)\s+(done|完了)$/i);
const reverseMissMatch = userText.match(/^(\S+)\s+(miss|未達)(?:\s+(.+))?$/i);

// 逆順の場合はエラーメッセージを返す
if (reverseDoneMatch) {
  const target = reverseDoneMatch[1];
  await replyText(replyToken, `⚠️形式が間違っている... 正しい形式: done ${target}`);
  return;
}
```

### 2. メッセージ分割表示

#### 日報開始時

**修正前（1つの長いメッセージ）:**
```
【日報】開始
終了: #日報終了

【未着手タスク一覧】（3件）
1) [A] レポートを作成する
   id:t_123 / 期限:2024-12-31
2) [B] 会議資料を準備する
   id:t_124
3) [C] メールを返信する
   id:t_125

【使い方（そのまま送ってOK）】
1) 完了: done 1（または done <taskId>）
2) 未達: miss 2 理由（理由は任意）
3) 一覧: list / 一覧
4) 対象: 対象 1,3（絞る） / 対象 全部（解除）
※番号は todo全件リスト基準（対象で絞っても番号は同じ）
※上記以外はメモとして記録
```

**修正後（3つの短いメッセージに分割）:**

メッセージ1:
```
【日報】開始
終了: #日報終了
```

メッセージ2:
```
【未着手タスク一覧】（3件）
1) [A] レポートを作成する
   id:t_123 / 期限:2024-12-31
2) [B] 会議資料を準備する
   id:t_124
3) [C] メールを返信する
   id:t_125
```

メッセージ3:
```
【報告方法】
✅完了: 1 done または done 1
❌未達: 2 miss 理由
📝メモ: その他は全てメモ

🔄一覧: list
🎯対象: 対象 1,3（絞込）
　　　　対象 全部（解除）
```

#### リスト表示時

**修正前（1つのメッセージ）:**
```
【未着手タスク一覧】（3件）
...
解除: 対象 全部 / 番号は全件基準
```

**修正後（2つのメッセージ）:**

メッセージ1:
```
【未着手タスク一覧】（3件）
...
```

メッセージ2:
```
報告: 1 done / 2 miss 理由
解除: 対象 全部
※番号は全件基準
```

### 3. 簡潔な応答メッセージ

#### 完了報告の応答

**修正前:**
```
完了登録: レポートを作成する
```

**修正後:**
```
✅完了: レポートを作成する
```

#### 未達報告の応答

**修正前:**
```
未達登録: レポートを作成する | 理由: 時間が足りなかった
```

**修正後:**
```
❌未達: レポートを作成する
理由: 時間が足りなかった
```

#### メモ記録の応答

**修正前:**
```
メモとして記録した。
次: done 1 / miss 2 理由 / list
```

**修正後:**
```
📝メモ記録
```

#### 対象設定の応答

**修正前:**
```
日報対象を設定した（2件）。
【日報対象タスク:】（2件）
...
```

**修正後（2つのメッセージ）:**

メッセージ1:
```
🎯対象設定（2件）
```

メッセージ2:
```
【日報対象タスク】（2件）
...
```

### 4. 新関数: replyTexts

複数メッセージを一度に送信する関数を追加：

```typescript
// lib/adapters/line.ts
export async function replyTexts(replyToken: string, texts: string[]) {
  if (!replyToken || !texts.length) return;
  const messages = texts.slice(0, 5).map(text => ({ type: "text" as const, text }));
  await getClient().replyMessage(replyToken, messages);
}
```

LINEの制限により、最大5つまでのメッセージを同時送信可能。

## 実装ファイル

### 修正したファイル

1. **app/api/line/webhook/route.ts**
   - 入力パターンの正規表現を拡張（逆順対応）
   - メッセージ分割表示に変更
   - 応答メッセージを簡潔化

2. **lib/adapters/line.ts**
   - `replyTexts` 関数を追加

3. **docs/bmad/spec-current.md**
   - 柔軟な入力形式を明記
   - メッセージ分割表示を追記

## 使用例

### ケース1: 完了報告（正しい形式）

**ユーザー入力:**
```
done 1
```

**システム応答:**
```
✅完了: レポートを作成する
```

### ケース2: 未達報告（正しい形式）

**ユーザー入力:**
```
miss 2 時間が足りなかった
```

**システム応答:**
```
❌未達: 会議資料を準備する
理由: 時間が足りなかった
```

### ケース3: 間違った形式のエラー検知

**ユーザー入力:**
```
1 done
```

**システム応答:**
```
⚠️形式が間違っている: 1 done

正しい形式:
done 1

理由: タスクIDは t_ から始まるので、
番号とIDを混同しないよう、動詞を先に書く。
```

### ケース4: 日報開始

**ユーザー入力:**
```
#日報開始
```

**システム応答（3つのメッセージ）:**

1️⃣
```
【日報】開始
終了: #日報終了
```

2️⃣
```
【未着手タスク一覧】（3件）
1) [A] レポートを作成する
   id:t_123 / 期限:2024-12-31
2) [B] 会議資料を準備する
   id:t_124
3) [C] メールを返信する
   id:t_125
```

3️⃣
```
【報告方法】
✅完了: done 1
❌未達: miss 2 理由
📝メモ: その他は全てメモ

🔄一覧: list
🎯対象: 対象 1,3（絞込）
　　　　対象 全部（解除）
```

## UX改善の効果

### 改善前の問題点

1. **混乱**: `1 done` が認識されず、ユーザーが「何がダメなのか」分からない
2. **曖昧性**: 仮に `1 done` を認識しても、タスクIDが `t_` から始まるため混乱を招く
3. **可読性**: 長いメッセージで重要な情報が埋もれる
4. **冗長性**: 毎回「次: done 1 / miss 2 理由 / list」が表示される

### 改善後の効果

1. ✅ **明確な形式**: `done 1`（動詞が先）のみを推奨し、混乱を避ける
2. ✅ **エラー検知**: 間違った形式の場合、具体的な修正案を提示
3. ✅ **可読性向上**: メッセージが分割され、必要な情報が見やすい
4. ✅ **簡潔**: 絵文字を使って一目で分かる（✅❌📝🔄🎯）
5. ✅ **認知負荷軽減**: 余計な説明がない

## 互換性

- ✅ **完全互換**: 既存の入力形式（`done 1`）は引き続き動作
- ⚠️ **逆順は無効**: `1 done` は動作しないが、具体的なエラーメッセージで修正案を提示
- ✅ **既存ユーザー影響なし**: 正しい形式（`done 1`）を使っていたユーザーには影響なし

## 今後の改善案

1. **コマンドヘルプ**: `help` でコマンド一覧を表示
2. **確認プロンプト**: 複数タスクの一括更新（`1,2,3 done`）
3. **クイックリプライ**: LINEのボタンで選択肢を提示
4. **エラー提案**: 入力ミス時に「もしかして: done 1?」のような提案

## まとめ

今回の改善により、日報の操作が**明確**で**分かりやすく**なりました。

- ✅ 明確な入力形式（`done 1` のみ推奨、動詞が先）
- ✅ 間違った形式の検知とエラーメッセージ
- ✅ メッセージ分割で可読性向上
- ✅ 簡潔な応答メッセージ
- ✅ 絵文字で視覚的に分かりやすく

**重要:**
- タスクIDが `t_` から始まるため、番号とIDの混同を避けるため、**動詞を先に書く**形式を推奨
- 間違った形式（`1 done`）を送ると、正しい形式（`done 1`）を提示するエラーメッセージが表示される

ユーザーは混乱なくタスクを報告でき、システムからの応答も短く明確になりました。
