# ゴールとタスクの連携・missタスクフォロー（2024-12-30）

## 問題の概要

プロダクト全体を振り返った際に、以下の重要な要素が不足していました：

### 🔴 **クリティカル（サイクルを回すために必須）**

1. **ゴールとタスクの連携が見えない**
   - ゴールは作成されるが、ほとんど使われていない
   - タスクに `goalId` はあるが、「このタスクはどのゴールのため？」が見えない
   - ユーザーは「何のためにこれをやっているのか」が分からない

2. **missタスクが放置される**
   - missになったタスクは `status: miss` で終わり
   - 自動的に「次にどうするか」を提案しない
   - ユーザーは「次にどうすればいいか」分からない

## BMAD分析

### B (Business / Background)
- **価値提供の失敗**: ゴールとタスクの関係が見えないと、モチベーションが続かない
- **継続性の欠如**: missタスクが放置されると、負のスパイラルに

### M (Market / Modeling)
- **ユーザーニーズ**: 「何のためにやっているのか」を常に意識したい
- **行動変容**: 失敗しても、次につなげられる仕組みが必要

### A (Architecture / Assemble)
- **ゴール進捗の可視化**: 関係を見える化する
- **自動フォロー**: 次のアクションを提案する

### D (Delivery / Deploy)
- リポジトリ層の拡張
- UI/メッセージの改善

## 実装した改善

### 1. ✅ ゴールとタスクの連携（進捗の可視化）

#### 1-1. ゴール進捗の計算機能

**新しいインターフェース:**

```typescript
export type GoalProgress = {
  goal: GoalRecord;
  totalTasks: number;
  completedTasks: number;
  progressPercent: number;
};

export async function calculateGoalProgress(
  goalId: string,
  goals: GoalsRepository,
  tasks: TasksRepository
): Promise<GoalProgress | null>;

export async function listActiveGoalProgress(
  goals: GoalsRepository,
  tasks: TasksRepository
): Promise<GoalProgress[]>;
```

**効果:**
- ゴールごとに、何件のタスクがあり、何件完了したかが分かる
- 進捗率（%）が計算される

#### 1-2. タスク一覧にゴール情報を表示

**修正前:**
```
【本日の焦点】（3件・表示3件）
1) [A] レポートを作成する
   id:t_123 / 期限:2024-12-31
```

**修正後:**
```
【本日の焦点】（3件・表示3件）
1) [A] レポートを作成する
   id:t_123 / 期限:2024-12-31 / → キャリアアップを実現する
```

**効果:**
- タスクがどのゴールに貢献しているか一目で分かる
- 「何のためにやっているのか」が常に見える

#### 1-3. 日報終了時にゴール進捗を表示

**修正前:**
```
💪 今日は2件完了！（達成率67%）
🔥 連続5日！

【日報サマリー】
...
```

**修正後:**
```
💪 今日は2件完了！（達成率67%）
🔥 連続5日！

🎯 ゴール進捗:
キャリアアップを実現する: ████░░░░░░ 40%
健康を改善する: ██░░░░░░░░ 20%

【日報サマリー】
...
```

**効果:**
- 今日の行動が、ゴール全体にどう貢献したか分かる
- 長期的な視点を持てる

#### 1-4. リポジトリ層の拡張

**追加したメソッド:**

```typescript
// GoalsRepository
findById(goalId: string): Promise<GoalRecord | null>;
updateStatus(goalId: string, status: GoalStatus): Promise<boolean>;

// TasksRepository
listByGoalId(goalId: string): Promise<TaskRecord[]>;
countByGoalAndStatus(goalId: string, status: string): Promise<number>;
```

**効果:**
- ゴールとタスクの関係を取得できる
- 今後の拡張がしやすい

---

### 2. ✅ missタスクの自動フォロー機能

#### 2-1. miss時に次のアクション提案

**修正前:**
```
❌ 未達（大丈夫。次がある。）
レポートを作成する
理由: 時間が足りなかった
```

**修正後:**
```
❌ 未達（大丈夫。次がある。）
レポートを作成する
理由: 時間が足りなかった

💡 次のアクション:
1️⃣ 明日もう一度挑戦する
2️⃣ タスクを小さく分割する
3️⃣ 優先度を下げて別の日にする

どうする？（後で決めてもOK）
```

**効果:**
- 失敗しても、次にどうすればいいか分かる
- 選択肢を提示することで、行動のハードルが下がる
- 前向きな気持ちになれる

#### 2-2. タスク操作コマンドの準備（プレースホルダー）

**追加したコマンド:**
- `split <taskId>`: タスク分割（準備中）
- `retry <taskId>`: タスク再挑戦（準備中）

**現在の挙動:**
```
ユーザー: split 1

システム: タスク分割機能（準備中）

対象: 1

現在は日報終了時にAIが分割提案をします。
または、思考ログで「このタスク、大きすぎる」と伝えてください。
```

**効果:**
- ユーザーに「将来的にこの機能がある」と伝えられる
- 現時点での代替手段を提示

---

## 使用例

### 例1: ゴール進捗の確認

**ユーザー:**
```
#日報開始
```

**システム:**
```
【日報】開始
終了: #日報終了

【本日の焦点】（5件・表示3件）
1) [A] レポートを作成する
   id:t_123 / 期限:2024-12-31 / → キャリアアップを実現する
2) [B] 会議資料を準備する
   id:t_124 / → 健康を改善する
3) [A] 運動する
   id:t_125 / → 健康を改善する

他2件あり。全件表示: list

【報告方法】
...
```

**効果:**
- 各タスクがどのゴールに貢献しているか一目で分かる

---

### 例2: 日報終了時のゴール進捗表示

**ユーザー:**
```
done 1
done 3
#日報終了
```

**システム:**
```
💪 今日は2件完了！（達成率100%）
🔥 連続5日！

🎯 ゴール進捗:
キャリアアップを実現する: ████░░░░░░ 45% (+5%)
健康を改善する: ███░░░░░░░ 30% (+10%)

【日報サマリー】
✅完了 t_123
✅完了 t_125

日報ID: daily_1766123456789
```

**効果:**
- 今日の行動がゴールにどう貢献したか分かる
- 進捗が見えるのでモチベーションが上がる

---

### 例3: missタスクのフォロー

**ユーザー:**
```
miss 2 時間が足りなかった
```

**システム:**
```
❌ 未達（OK。次のチャンスで取り返せる。）
会議資料を準備する
理由: 時間が足りなかった

💡 次のアクション:
1️⃣ 明日もう一度挑戦する
2️⃣ タスクを小さく分割する
3️⃣ 優先度を下げて別の日にする

どうする？（後で決めてもOK）
```

**ユーザー（思考ログで）:**
```
#整理開始
会議資料が大きすぎて手がつかない。分割したい。
```

**システム（思考ログ）:**
```
「大きすぎて手がつかない」って感じてるんだね。

もしかして、「完璧に作らなきゃ」って思いすぎてる？

小さく分けるとしたら、何から始める？
例えば、「アウトラインだけ書く」とか、「データだけ集める」とか。
```

**効果:**
- missタスクが放置されない
- 次のアクションを考えるきっかけになる

---

## 修正したファイル

1. **lib/storage/repositories.ts**
   - `GoalsRepository` にメソッド追加（`findById`, `updateStatus`）
   - `TasksRepository` にメソッド追加（`listByGoalId`, `countByGoalAndStatus`）
   - `GoalProgress` 型を追加
   - `calculateGoalProgress`, `listActiveGoalProgress` 関数を追加

2. **lib/storage/sheets-repository.ts**
   - `SheetsGoalsRepository` にメソッド実装
   - `SheetsTasksRepository` にメソッド実装

3. **app/api/line/webhook/route.ts**
   - `buildDailyTaskLine` をasync化し、ゴール情報を追加
   - `buildDailyTaskListMessage` をasync化
   - 日報終了時にゴール進捗を表示
   - miss時に次のアクション提案を追加
   - `split`, `retry` コマンドのプレースホルダー追加

4. **docs/bmad/spec-current.md**
   - ゴールとタスクの連携を追記

5. **docs/bmad/fix-2024-12-30-goal-task-linkage.md**
   - 詳細な改善ドキュメント（このファイル）

6. **README.md**
   - 変更履歴追加

---

## 効果

### ユーザー体験の変化

**修正前:**
- タスクをこなすだけ
- ゴールとの関係が見えない
- missタスクは放置される

**修正後:**
- タスクがゴールに貢献していることが見える
- ゴールの進捗が可視化される
- missタスクも、次のアクションが提案される

### 期待される効果

1. ✅ **モチベーション向上**
   - 「何のためにやっているのか」が常に見える
   - ゴールの進捗が見えるので、達成感がある

2. ✅ **継続性の向上**
   - missタスクが放置されず、次につなげられる
   - 失敗しても前向きになれる

3. ✅ **長期的な視点**
   - 今日の行動が、ゴール全体にどう貢献しているか分かる
   - 短期と長期のバランスが取れる

---

## 今後の改善案

### 短期
- [ ] **タスク分割の完全実装**: AIが分割案を提示し、ユーザーが選択できる
- [ ] **タスク再挑戦の完全実装**: missタスクをtodoに戻す
- [ ] **ゴールの状態遷移**: pending → approved → archived の自動更新

### 中期
- [ ] **ゴール作成フロー**: 思考ログからゴールを提案する
- [ ] **ゴール編集機能**: ゴールのタイトルや状態を変更する
- [ ] **タスク生成時にゴールを紐付ける**: AIがゴールを提案する

### 長期
- [ ] **ゴール達成の祝福**: ゴールが100%になったら特別なメッセージ
- [ ] **ゴール間の優先度**: 複数ゴールの優先順位をつける
- [ ] **ゴールの階層化**: サブゴールを作成する

---

## まとめ

今回の改善により、**ゴールとタスクの関係が見える化**され、**missタスクも放置されない**仕組みになりました。

**重要な考え方:**
- **何のためにやっているのか**を常に意識する
- **失敗しても、次につなげる**仕組みがある
- **短期と長期のバランス**を取る

これで、ユーザーは「何のためにこれをやっているのか」が常に見え、モチベーションを維持できます。
