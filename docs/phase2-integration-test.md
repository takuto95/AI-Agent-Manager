# Phase 2 統合テスト手順

このドキュメントでは、リッチメニュー & LIFF アプリの統合テストを行う手順を説明します。

---

## 前提条件

- ✅ Vercelにデプロイ済み
- ✅ LIFF アプリを作成済み（LIFF ID取得済み）
- ✅ リッチメニュー画像を準備済み
- ✅ 環境変数を設定済み

---

## テスト1: リッチメニューの表示確認

### 目的
リッチメニューが正しく表示され、各ボタンが動作するか確認。

### 手順

1. **LINE公式アカウントのトーク画面を開く**
   - スマートフォンでLINEアプリを起動
   - 設定したLINE公式アカウントのトークを開く

2. **リッチメニューが表示されているか確認**
   - 画面下部に常時表示されているか
   - 6つのボタン（または4つ）が表示されているか
   - 画像が正しく表示されているか（文字が読めるか）

3. **各ボタンをタップしてテスト**

| ボタン | 期待される動作 | 確認項目 |
|--------|--------------|----------|
| 🎯 今日のタスク | `#今日のタスク` が送信される | メッセージが表示されるか |
| 📋 タスク一覧 | LIFF アプリが開く | 全画面でWebアプリが表示されるか |
| ✅ 完了報告 | `完了` が送信される | メッセージが表示されるか |
| 📊 ステータス | `#ステータス` が送信される | ステータス確認モードになるか |
| 💭 思考ログ | `#整理開始` が送信される | 思考ログモードになるか |
| ❓ ヘルプ | `?` が送信される | ヘルプメッセージが表示されるか |

### 期待結果
- ✅ リッチメニューが表示される
- ✅ すべてのボタンが正しく動作する
- ✅ タップ反応が良好（遅延がない）

### トラブルシューティング

**リッチメニューが表示されない:**
```bash
# リッチメニューの一覧を確認
npm run setup-rich-menu -- list

# デフォルト設定されているか確認
# 出力に「⭐ デフォルト: <richMenuId>」が表示されるはず
```

**ボタンをタップしても反応しない:**
- 画像のタップ領域と設定が一致しているか確認
- `lib/line/rich-menu-config.ts` の `bounds` 座標を確認

---

## テスト2: LIFF アプリの起動確認

### 目的
LIFF アプリが正しく起動し、初期表示が正常か確認。

### 手順

1. **LIFFアプリを開く**
   - リッチメニューの「📋 タスク一覧」をタップ
   - または、直接URLを開く: `https://liff.line.me/YOUR_LIFF_ID`

2. **初期表示を確認**
   - ✅ 全画面で表示される
   - ✅ ヘッダーに「📋 タスク一覧」が表示される
   - ✅ 統計情報が表示される（残り・完了・達成率）
   - ✅ フィルタボタンが表示される（すべて・A・B・C・期限近い）
   - ✅ タスクカードが表示される

3. **読み込み状態を確認**
   - 「📥 読み込み中...」が一瞬表示される
   - タスクが正しく読み込まれる
   - エラーメッセージが表示されない

### 期待結果
- ✅ LIFFアプリが全画面で開く
- ✅ タスク一覧が表示される
- ✅ 統計情報が正確に表示される
- ✅ 読み込みが3秒以内に完了する

### トラブルシューティング

**LIFFアプリが開かない:**
1. ブラウザの開発者ツールを開く（PCのLINE等で確認）
2. コンソールログでエラーを確認
3. LIFF IDが正しいか確認:
   ```javascript
   // public/liff/tasks.html の確認
   const liffId = '1234567890-AbCdEfGh'; // 正しいIDか？
   ```

**「タスクの読み込みに失敗しました」と表示される:**
1. `/api/tasks` エンドポイントが動作しているか確認:
   ```bash
   curl https://your-app.vercel.app/api/tasks
   ```
2. Google Sheetsのtasksシートにデータがあるか確認
3. 環境変数が正しく設定されているか確認（Vercel Dashboard）

---

## テスト3: タスクカードの表示確認

### 目的
タスクカードが正しく表示され、情報が正確か確認。

### 手順

1. **タスクカードの表示内容を確認**

各タスクカードに以下が表示されているか：
- ✅ 優先度バッジ（A: 赤、B: オレンジ、C: 緑）
- ✅ タスク説明文（読みやすく表示される）
- ✅ 期限情報（「あと2日」等）
- ✅ ゴール名（設定されている場合）
- ✅ ボタン（✅完了、❌未達）

2. **優先度の色分けを確認**
- 優先度A: 赤色（#dc2626）
- 優先度B: オレンジ色（#ea580c）
- 優先度C: 緑色（#059669）

3. **期限の強調表示を確認**
- 期限が3日以内: 赤色で「あと2日」等が表示される
- 期限切れ: 「期限切れ」と赤色で表示される

4. **ゴール情報を確認**
- ゴールが設定されているタスクに青いバッジが表示される
- ゴール名が正しく表示される

### 期待結果
- ✅ すべてのタスクカードが正しく表示される
- ✅ 優先度が色分けされている
- ✅ 期限が近いタスクが強調表示される
- ✅ ゴール情報が正しく表示される

---

## テスト4: フィルタ機能のテスト

### 目的
フィルタボタンが正しく動作し、タスクが絞り込まれるか確認。

### 手順

1. **「優先度A」ボタンをタップ**
   - 優先度Aのタスクのみ表示される
   - 他の優先度のタスクは非表示になる
   - ボタンがアクティブ状態（青色）になる

2. **「優先度B」ボタンをタップ**
   - 優先度Bのタスクのみ表示される

3. **「優先度C」ボタンをタップ**
   - 優先度Cのタスクのみ表示される

4. **「期限近い」ボタンをタップ**
   - 期限が3日以内のタスクのみ表示される

5. **「すべて」ボタンをタップ**
   - すべてのタスクが表示される

### 期待結果
- ✅ フィルタが正しく動作する
- ✅ 即座に絞り込まれる（遅延がない）
- ✅ アクティブなボタンが視覚的に分かる
- ✅ フィルタ解除が正しく動作する

---

## テスト5: ボタン操作のテスト

### 目的
✅完了ボタンと❌未達ボタンが正しく動作するか確認。

### 手順

1. **✅完了ボタンをタップ**
   - トーストメッセージが表示される（「✅ 完了を報告しました」）
   - タスクカードがフェードアウトして消える
   - 統計情報が更新される（完了数が+1）

2. **LINEトーク画面を確認**
   - `done t_123456789` というメッセージが送信されている
   - 日報モードの場合、タスクが完了扱いになる

3. **❌未達ボタンをタップ**
   - トーストメッセージが表示される（「❌ 未達を報告しました」）
   - タスクカードがフェードアウトして消える

4. **LINEトーク画面を確認**
   - `miss t_123456789` というメッセージが送信されている

### 期待結果
- ✅ ボタンが正しく動作する
- ✅ LINEにメッセージが送信される
- ✅ タスクカードが消える
- ✅ 統計情報が更新される
- ✅ トーストメッセージが表示される

### トラブルシューティング

**ボタンをタップしてもメッセージが送信されない:**
1. LIFF の Scope に `chat_message.write` が設定されているか確認
2. コンソールログでエラーを確認
3. `liff.sendMessages()` が実行されているか確認

---

## テスト6: スワイプジェスチャーのテスト

### 目的
スワイプ操作で完了/未達を報告できるか確認。

### 手順

1. **タスクカードを左にスワイプ**
   - カードが左に移動する
   - 緑色の背景に「✅」が表示される
   - 指を離すと「✅ 完了を報告しました」のトーストが表示される
   - タスクカードが消える

2. **タスクカードを右にスワイプ**
   - カードが右に移動する
   - 赤色の背景に「❌」が表示される
   - 指を離すと「❌ 未達を報告しました」のトーストが表示される
   - タスクカードが消える

3. **中途半端なスワイプをテスト**
   - 少しだけスワイプして指を離す
   - カードが元の位置に戻る（何も送信されない）

### 期待結果
- ✅ スワイプジェスチャーが正しく動作する
- ✅ スワイプ中に視覚的フィードバックがある
- ✅ 完了/未達が正しく判定される
- ✅ 中途半端なスワイプではアクションが実行されない

---

## テスト7: 統計情報の正確性テスト

### 目的
統計情報が正確に計算・表示されるか確認。

### 手順

1. **初期状態の統計を確認**
   - 残りタスク数
   - 完了タスク数
   - 達成率

2. **タスクを1つ完了する**
   - ✅完了ボタンをタップ
   - 統計が即座に更新されるか確認
   - 残りタスク数が-1になるか
   - 完了タスク数が+1になるか
   - 達成率が正しく計算されるか

3. **タスクを複数完了する**
   - 2つ目、3つ目のタスクを完了
   - 統計が正しく累計されるか確認

4. **Google Sheetsで確認**
   - tasksシートを開く
   - statusが「done」に更新されているか確認

### 期待結果
- ✅ 統計情報が正確に表示される
- ✅ 操作後に即座に更新される
- ✅ 達成率の計算が正しい
- ✅ Google Sheetsのデータと一致する

---

## テスト8: エッジケースのテスト

### 目的
特殊なケースでもアプリが正常に動作するか確認。

### 手順

1. **タスクが0件の場合**
   - すべてのタスクを完了する
   - 空の状態メッセージが表示されるか確認
   - 「✨ タスクがありません」と表示されるか

2. **フィルタで0件になる場合**
   - 「優先度A」フィルタを選択
   - 該当タスクがない場合、空メッセージが表示されるか
   - 「フィルタ条件を変更してください」と表示されるか

3. **ゴール情報がない場合**
   - goalIdが設定されていないタスクを確認
   - ゴールバッジが表示されないか確認
   - エラーが発生しないか確認

4. **期限がない場合**
   - dueDateが空のタスクを確認
   - 「なし」と表示されるか確認

5. **長いタスク名の場合**
   - 非常に長いタスク説明を確認
   - 複数行で折り返されるか確認
   - カードのレイアウトが崩れないか確認

### 期待結果
- ✅ すべてのエッジケースで正常に動作する
- ✅ エラーが発生しない
- ✅ 適切なフォールバック表示がある

---

## テスト9: パフォーマンステスト

### 目的
アプリが快適に動作するか確認。

### 手順

1. **読み込み速度を測定**
   - LIFFアプリを開く
   - 読み込み完了までの時間を測定
   - 目標: 3秒以内

2. **スクロールの滑らかさを確認**
   - タスク一覧を上下にスクロール
   - カクつきがないか確認

3. **ボタン反応速度を確認**
   - フィルタボタンをタップ
   - 完了ボタンをタップ
   - 目標: 即座に反応（100ms以内）

4. **スワイプ操作の滑らかさを確認**
   - タスクカードをスワイプ
   - 指の動きに追従するか確認

### 期待結果
- ✅ 読み込みが3秒以内
- ✅ スクロールが滑らか
- ✅ ボタン反応が即座
- ✅ スワイプ操作が滑らか

---

## テスト10: 統合シナリオテスト

### 目的
実際の利用シーンでアプリが正しく動作するか確認。

### シナリオ1: 朝のタスク確認 → 完了報告

1. 朝7時に通知が届く（Flex Message）
2. 通知を見てタスク内容を確認
3. 「✅ 今すぐ開始」ボタンをタップ
4. タスクに取り組む
5. リッチメニューの「タスク一覧」を開く
6. 対象タスクを左にスワイプして完了報告
7. LINEトークに `done` メッセージが送信される
8. 統計が更新される

### シナリオ2: 日中のタスク追加確認

1. リッチメニューの「タスク一覧」を開く
2. 新しいタスクが追加されているか確認
3. フィルタで優先度Aのみ表示
4. 期限が近いタスクを確認
5. 重要なタスクを✅完了ボタンで報告

### シナリオ3: 夕方の進捗確認

1. リッチメニューの「ステータス」をタップ
2. 今日の進捗を確認
3. タスク一覧を開いて残りタスクを確認
4. 残り1件のタスクを完了報告
5. 達成率が100%になることを確認

### 期待結果
- ✅ すべてのシナリオがスムーズに完了する
- ✅ 各ステップで適切なフィードバックがある
- ✅ データの整合性が保たれる

---

## チェックリスト

すべてのテストが完了したら、以下を確認：

### リッチメニュー
- [ ] リッチメニューが表示される
- [ ] すべてのボタンが動作する
- [ ] タップ反応が良好
- [ ] メニュー画像が鮮明

### LIFF アプリ
- [ ] アプリが全画面で開く
- [ ] タスク一覧が表示される
- [ ] 統計情報が正確
- [ ] フィルタが動作する
- [ ] ボタン操作が正常
- [ ] スワイプ操作が滑らか
- [ ] トーストメッセージが表示される
- [ ] LINEにメッセージが送信される

### パフォーマンス
- [ ] 読み込みが3秒以内
- [ ] スクロールが滑らか
- [ ] ボタン反応が即座
- [ ] エラーが発生しない

### データ整合性
- [ ] 統計が正確
- [ ] Google Sheetsと一致
- [ ] タスク状態が正しく更新される

---

## 本番リリース前の最終確認

1. **環境変数の確認**
   - すべての必須環境変数が設定されているか
   - 本番用の値が設定されているか（開発用ではない）

2. **LIFF IDの確認**
   - 本番用のLIFF IDが設定されているか
   - エンドポイントURLが正しいか

3. **リッチメニューの確認**
   - 本番アカウントに設定されているか
   - デフォルトメニューとして設定されているか

4. **バックアップ**
   - Google Sheetsのバックアップを取得
   - 環境変数のバックアップを取得

5. **ロールバック手順の確認**
   - 問題が発生した場合の対処方法を確認
   - 旧バージョンへの切り戻し手順を確認

---

## テスト完了後

すべてのテストが成功したら、以下を実施：

1. **ドキュメントを更新**
   - `docs/bmad/spec-current.md` に実装内容を追記
   - リリースノートを作成

2. **ユーザーに案内**
   - 新機能の使い方を説明
   - リッチメニューとLIFFアプリの活用方法を案内

3. **モニタリング**
   - 初日はエラーログを監視
   - ユーザーフィードバックを収集
   - パフォーマンスを監視

おめでとうございます！🎉 Phase 2の実装とテストが完了しました。
